<html>

<head>
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <title>Vireo II refman</title>
</head>

<body>
    <style>
        body{
            font-family: 'Lato', sans-serif;
            margin: 0px;
        }

        h1, h2 {
            text-align: center;
            margin: 10px;
        }
        
        h3{
            text-align: left;
            margin: 10px;
        }
        p{
            padding-bottom: 20px;
            border-bottom: solid 1px #000000;
            margin: 10px;
            margin-right: 10%;
        }
        table, th, td{
            border: solid 1px lightgray;
            border-collapse: collapse;
            margin: 10px;
        }
       
        caption
    {
            margin: 10px;
            caption-side: bottom;
            font-size: 10pt;
        }
    </style>
    
    <h1 id="top">VIREO II - REFMAN</h1>
    <p style="text-align: center; margin-right: 0px; border-bottom: none"><i>Technical notes and documentation for the Vireo II kernel.</i></p>

    <p style="text-align: center; margin-right: 0px">
        <strong>Index</strong><br><br>
        <a href="#introduction">1. Introduction to Vireo II</a><br>
        <a href="#building">2. Building the kernel</a><br>
        <a href="#debugging">3. Debugging the kernel</a><br>
        <a href="#exit_codes">4. Exit codes</a><br>
        
        <br><br>
        <strong>Appendixes</strong><br><br>
        <a href="#funclist">A0 - Function listing</a><br>
        <a href="#license">MIT license</a><br>
    </p>
    <br>

    <h3 id="introduction">1. Introduction to Vireo II</h3>
    <p>Vireo II is a rewrite of the Vireo I kernel, which was a very unstable and poorly thought through kernel. Vireo I lacked a good architecture and good coding practices, and was compiled using the system compiler.
        The new Vireo II should improve this quite a bit. It's rewritten, though not entirely from scratch: some code from the Vireo I kernel will be 'upcycled' into the new Vireo II kernel.  
        <br><br><br>

        <strong><i>Vireo I vs Vireo II</i></strong>
        <br>Vireo I was very unstable and annoying to work with, because of the lack of planning beforehand. Furthermore, Vireo I used the GCC system compiler instead of a cross-compiler.
        It had trouble with the keyboard and mouse, PATAPI and more. Some ISRs didn't seem to work. Not all of these problems were caused by the GCC system compiler, but they are annoying bugs and problems nevertheless.
        Vireo II will improve on Vireo I in a few key ways:<br>
        <br>- <b>Vireo II will be easier to work with;</b> thanks to a more dynamic makefile, more documentation, better function names and handling, etc.
        <br>- <b>Vireo II will be better suited as an OS;</b> thanks to a new cross-compiler and better handling of its working environment.
        <br>- <b>5 years more experience;</b> which means, or should mean, better source code and a better kernel.   
        <br><br><br>

        <strong><i>About Vireo I</i></strong>
        <br>The project started on September 14th 2014 as a 16-bit kernel. After a long period of time, in which nothing was done, the project was renewed. This time 
        by making a 32-bit kernel with a GUI (the GUI was never made). Back then it had no name. Later on, however, it got the name Bird OS. In 2018 the Bird OS name was split up with a name for the GUI (Bluebird) and the kernel (Vireo). 
        Halfway through 2019, the creator saw how awful the kernel was and thought it would be best to start all over... again.
        <br><br>This is not to say, however, that Vireo I can't be used for anything. It may be a bad and picky kernel, which really wants some things to be there (for example, it needs a FAT32 formatted PATA harddrive with a BIRDOS directory on it in order to work).
        However, you may be succesful at doing something with it. It cannot load ELF binaries, but it is able to single task flat binaries. This, unfortunately, does require some extra code to be written for it to find and execute the binary. There are functions to find files and execute a flat binary somewhere in the kernel, which can be used for this purpose.
         There's only one catch: there is no documentation for Vireo I.

        <br><br><br>
        <strong><i>About this manual</i></strong>
        <br>This manual is updated, as necessary, alongside the development of the kernel. This manual may be trusted above any other, possibly conflicting, sources; with an exception to the current source code, which is considered as more authoritative.
        <br><br>
    </p>
    
    <h3 id="building">2. Building the kernel</h3>
    <p>The kernel is built using a GCC cross-compiler and NASM, using the utillity called <a target="_blank" href="https://github.com/m44rtn/xenops">Xenops</a> to increase the build number with every build, for the next build. Currently, the kernel is built using an i686-elf
        cross-compiler using GCC v8.3.0. A cross-compiler is not included with the source, but you can use <a target="_blank" href="https://wiki.osdev.org/GCC_Cross-Compiler">this guide</a> to easily build one yourself.
        <br><br>
        Use <code>make all</code> to build the entire kernel.<br>
        Use <code>make iso</code> to make an ISO image using that kernel.<br>
        <br>
        Not every option in the makefile is (or will be) documented, but you can take a look at the makefile in the GitHub repository to see all the options.
        <br><br>
    </p>

    <h3 id="debugging">3. Debugging the kernel</h3>
    <p>Virtualbox is used to test and debug the kernel. Using the makefile, the <code>make run</code> command will run any virtual machine called "Bird OS" (without "), and will automatically launch the Virtualbox debug console.
        You can use this console to debug the kernel. A few useful commands of the Virtualbox debug console are listed in <i>table 3.0</i>. <br><br>
        <table style="width: 100%">
            <caption>Table 3.0 - Useful Virtualbox debug console commands</caption>
            <colgroup>
                <col width="30%">
                <col width="70%">
            </colgroup>
            <th>Command</th>
            <th>Description</th>
            <tr>
                <td>d (address)</td>
                <td>Dump memory at adress specified</td>
            </tr>
            <tr>
                <td>r</td>
                <td>Display active register set. In case of a Guru Meditation use <i>rg</i> instead.</td>
            </tr>
            <tr>
                <td>rg</td>
                <td>Display guest register set.</td>
            </tr>
            <tr>
                <td>sa (address) "string"</td>
                <td>Search for an ASCII string.</td>
            </tr>
            <tr>
                <td>t</td>
                <td>Trace/Single-step through, one instruction at a time.</td>
            </tr>
            <tr>
                <td>u16/u32 (address)</td>
                <td>Unassemble 16-bit/32-bit code at the address specified.</td>
            </tr>
        </table>
        <br>
    </p>

    <h3 id="exit_codes">4. Exit codes</h3>
    <p>
        Exit codes in the kernel are one byte long (<code>unsigned char</code>), meaning a maximum of 256 error codes, and indicate if the function has executed correctly. When an error occurs a function will return a non-zero exit code which indicates the type of error.
        Although every module may have its own exit codes, the kernel provides some global exit codes. <br>

        <br>The first sixteen error codes (0 - 15) are reserved for global use. Modules shouldn't use the values of these exit codes to indicate a different 'state' than described in <i>table 5.0</i>.<br><br>
        Not all functions return exit codes, in fact initialization functions are the the most likely to return exit codes. It is possible that non-initialization functions will return an exit code.<br><br>
        
        Module specific exit codes can be found in their <a href="#funclist">function listing</a>.
        <br><br>
       
       <table style="width: 100%">
        <caption>Table 5.0 - Global exit codes</caption>
        <colgroup>
            <col width="33%">
            <col width="5%">
            <col width="33%">
        </colgroup>
        <th>Name</th>
        <th>Value</th>
        <th>Description</th>
        <tr>
            <td>EXIT_CODE_GLOBAL_SUCCESS</td>
            <td>0</td>
            <td>Means the function was executed correctly without any error</td>
        </tr>
        <tr>
            <td>EXIT_CODE_GLOBAL_GENERAL_FAIL</td>
            <td>1</td>
            <td>Means the function failed, but with no specific error</td>
        </tr>
        <tr>
            <td><i>&lt;reserved&gt;</i></td>
            <td>2 - 15</td>
            <td>Reserved for future use</td>
        </tr>
    </table>

    </p>

    <h3 id="funclist">A0 - Function listing</h3>
    <p>
        In every module (aka source code file) of the kernel, there are two kinds of functions: static (internal) and public functions. Static functions are not available to other modules and are inaccessible to them, they are not documented in this reference manual. Documentation for the static functions can be found in the code where necessary, as code comments.
        <br><br>Public functions are available to every module in the kernel.

        <br><br><br>

        <strong><i>Global functions - global_functions</i></strong>
        <br><i>global_functions</i> is a module which contains a few basic functions.
        <br><br><strong>Note:</strong> functions in this module DO NOT have a file name prefix (e.g. global_functions_[function name]).
        
        <br><br>
        
        <table style="width: 100%">
            <caption>Table A0.0 - global functions</caption>
            <colgroup>
                <col width="33%">
                <col width="33%">
                <col width="33%">
            </colgroup>
            <th>Function & description</th>
            <th>Input (var name, description)</th>
            <th>Returns, type/size</th>
            <tr>
                <td><code>flag_check()</code><br><br>
                    Checks if a flag has certain flags enabled.
                </td>

                <td>
                    - <code>flag</code>, flag<br>
                    - <code>to_check</code>, flag(s) to check for (OR'ed together)
                </td>

                <td>Exit code, BYTE:<br>
                    &nbsp; &nbsp; - EXIT_CODE_GLOBAL_SUCCESS, if all the flags are enabled<br>
                    &nbsp; &nbsp; - EXIT_CODE_GLOBAL_GENERAL_FAIL, if any one of them is not enabled
                </td>
            </tr>
        </table>

        <i>This module has no additional exit codes.</i>

        <br><br>
        <strong><i>Utillity functions - util</i></strong>
        <br><i>util</i> is a module that contains small functions.
        <br><br><strong>Note:</strong> functions in this module DO NOT have a file name prefix (e.g. util_[function name]).

        <table style="width: 100%">
            <caption>Table A0.1 - util module functions</caption>
            <colgroup>
                <col width="33%">
                <col width="30%">
                <col width="36%">
            </colgroup>
            <th>Function & description</th>
            <th>Input (var name, description)</th>
            <th>Returns, type/size</th>
            <tr>
                <td><code>strlen()</code><br><br>
                    Returns the length of a string (null byte excluded).
                </td>

                <td>- <code>str</code>, the string for which to count the length</td>

                <td>- Length of the string (uint32_t)
                </td>
            </tr>

            <tr>
                <td>
                    <code>hexstr()</code><br><br>
                    Converts an integer to a string with the value in hexadecimal format.
                </td>
                <td>- <code>value</code>, the integer to be converted</td>
                <td>- A new string containing the result</td>
            </tr>

            <tr>
                <td><code>intstr()</code><br><br>
                Converts an integer to a string with the value in base ten.</td>

                <td>- <code>value</code>, the integer to be converted</td>
                <td>- A new string containing the result</td>
            </tr>

            <tr>
                <td><code>digit_count()</code><br><br>
                Returns the amount of digits in an integer.</td>
                <td>- <code>value</code></td>
                <td>- The amount of digits in the value</td>
            </tr>

            <tr>
                <td><code>memset()</code><br><br>
                Sets the value in a region of memory</td>
                <td>- <code>start</code>, the start location of the region (as <code>char *</code>)<br>
                    - <code>size</code>, the length of the region<br>
                    - <code>val</code>, the memory locations within the region get this value
                </td>
                <td>N/A</td>
            </tr>
         
        </table>
        <i>This module has no additional exit codes.</i>
        <br><br>
        
        <strong><i>Basic screen functions - basic_screen</i></strong>
        <br><i>basic_screen</i> provides a simple interface to print text to the screen in text mode. The module is used by the kernel
        at start-up and needs text mode to be already enabled by the BIOS. The list of functions in this module:
        <br><br>
        
        <table style="width: 100%">
            <caption>Table A0.2 - screen_basic module functions</caption>
            <colgroup>
                <col width="33%">
                <col width="30%">
                <col width="36%">
            </colgroup>
            <th>Function & description</th>
            <th>Input (var name, description)</th>
            <th>Returns, type/size</th>
            <tr>
                <td><code>screen_basic_init()</code><br><br>
                    Initializes the internal variables for the module, enables the cursor and clears the screen.
                </td>

                <td>N/A</td>

                <td>Exit code, BYTE:<br>
                    &nbsp; &nbsp; - EXIT_CODE_GLOBAL_SUCCESS, if successful
                </td>
            </tr>
            <tr>
                    <td><code>screen_basic_enable_cursor()</code><br><br>
                        Enables the cursor and sets the start and end of the scanlines.
                    </td>
    
                    <td>- <code>cursor_start</code>, start of scanline<br>
                    - <code>cursor_end</code>, end of scanline</td>
    
                    <td>N/A</td>
             </tr>
            <tr>
                        <td><br><code>screen_basic_disable_cursor()</code><br><br>
                            Disables the cursor.
                        </td>
        
                        <td>N/A</td>
        
                        <td>Exit code, BYTE:<br>
                            &nbsp; &nbsp; - EXIT_CODE_GLOBAL_SUCCESS, if successful<br>
                            &nbsp; &nbsp; - SCREEN_BASIC_EXIT_CODE_CURSOR_MOVE_FAIL, if somehow unsuccessful
                        </td>
                </tr>
                <tr>
                            <td><code>screen_basic_move_cursor()</code><br><br>
                                Moves the cursor to the desired x and y position.
                            </td>
            
                            <td>- <code>x</code>, new x position, BYTE<br>
                                - <code>y</code>, new y position, BYTE
                            </td>
            
                            <td>N/A</td>
                </tr>
                <tr>
                        <td><code>screen_basic_get_cursor_position()</code><br><br>
                            Gets the cursor position and returns it.
                        </td>
        
                        <td>N/A</td>
        
                        <td>- cursor position, WORD</td>
                </tr>
                <tr>
                        <td><code>screen_basic_set_screen_color()</code><br><br>
                            Sets the screen color.
                        </td>
        
                        <td>- <code>color</code>, screen color (e.g. 0x07 light grey on black, 0x0F white on black), BYTE</td>
        
                        <td>N/A</td>
                </tr>
                <tr>
                    <td><code>trace()</code><br><br>
                        Prints text to the screen, and provides the option to
                        show integers on the screen.
                    </td>
    
                    <td>- <code>str</code>, null-termintated string<br>
                        - <code>val</code>, value/pointer (depending on option)<br><br>

                        options:<br>
                        &nbsp; &nbsp; %i - integer to decimal text<br>
                        &nbsp; &nbsp; %x - integer to hexadecimal text<br>
                        &nbsp; &nbsp; %s - string<br>

                        <br>Options are included within the null terminated string at the position where the text should show.
                    </td>
    
                    <td>N/A</td>
            </tr>
            <tr>
                <td><code>print()</code><br><br>
                    Prints text to the screen.
                </td>

                <td>- <code>str</code>, null-termintated string</td>

                <td>N/A</td>
            </tr>
            <tr>
                <td><code>screen_basic_clear_screen()</code><br><br>
                        Clears the screen.
                </td>
    
                <td>N/A</td>
    
                <td>N/A</td>
            </tr>
        </table>

        Additional exit codes:
        <table style="width: 100%">
            <caption>Table A0.3 - screen_basic module additional exit codes</caption>
            <colgroup>
                <col width="33%">
                <col width="5%">
                <col width="33%">
            </colgroup>
            <th>Name</th>
            <th>Value</th>
            <th>Description</th>
            <tr>
                <td>SCREEN_BASIC_EXIT_CODE_CURSOR_MOVE_FAIL</td>
                <td>16</td>
                <td>Means the cursor wasn't moved correctly</td>
            </tr>
        </table>
        <br><Br>

        <strong><i>GDT functions - gdt</i></strong>
        <br><i>gdt</i> is THE module for all stuff GDT. It's responisble for setting up the new GDT
        after sart-up.

        <table style="width: 100%">
            <caption>Table A0.4 - gdt module functions</caption>
            <colgroup>
                <col width="33%">
                <col width="30%">
                <col width="36%">
            </colgroup>
            <th>Function & description</th>
            <th>Input (var name, description)</th>
            <th>Returns, type/size</th>
            <tr>
                <td><code>GDT_setup()</code><br><br>
                    Initializes the default kernel GDT, without a TSS
                </td>

                <td>- GDT_ACCESS access
                    <br>
                    - GDT_FLAGS flags<br>
                    For what GDT_FLAGS and
                    GDT_ACCESS are, see gdt.h
                </td>

                <td>N/A
                </td>
            </tr>
            
        </table>

        <i>This module has no additional exit codes.</i>

        <br><br>

        <strong><i>IDT functions - idt</i></strong>
        <br><i>idt</i> is the module that handles everything in the IDT. It's responisble for setting up a basic IDT
        after sart-up and for adding new handlers to that IDT. 
        
        <table style="width: 100%">
            <caption>Table A0.5 - idt module functions</caption>
            <colgroup>
                <col width="33%">
                <col width="30%">
                <col width="36%">
            </colgroup>
            <th>Function & description</th>
            <th>Input (var name, description)</th>
            <th>Returns, type/size</th>
            <tr>
                <td><code>IDT_setup()</code><br><br>
                    Initializes the IDT with some basic handlers.
                </td>

                <td>N/A
                </td>

                <td>N/A
                </td>
            </tr>

            <tr>
                <td><code>IDT_add_handler()</code><br><br>
                Adds a new interrupt handler to the IDT</td>

                <td>- <code>index</code>, the entry in the IDT where the new handler should be<br>
                - <code>handler</code> the pointer to the handler (as uint32_t)</td>

                <td>
                    N/A
                </td>
            </tr>

            <tr>
                <td><code>IDT_reset()</code><br><br>
                Resets the <code>lidt</code> register with the updated IDT</td>

                <td>N/A</td>
                <td>N/A</td>
            </tr>
            
        </table>
        <br>
        <i>This module has no additional exit codes.</i>
        <br><br>
    </p>

    <h3 id="license">MIT license</h3>
    <p style="border-bottom: none;">
        
        Copyright (c) 2019 Maarten Vermeulen<br>
        <br>
        Permission is hereby granted, free of charge, to any person obtaining a copy<br>
        of this software and associated documentation files (the "Software"), to deal<br>
        in the Software without restriction, including without limitation the rights<br>
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell<br>
        copies of the Software, and to permit persons to whom the Software is<br>
        furnished to do so, subject to the following conditions:<br>
        <br>
        The above copyright notice and this permission notice shall be included in all<br>
        copies or substantial portions of the Software.<br>
        <br>
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR<br>
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,<br>
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE<br>
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER<br>
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,<br>
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE<br>
        SOFTWARE.<br>
        <br>
    </p>


    
    
</body>

</html>